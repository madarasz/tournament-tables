# Docker Compose overrides for E2E testing with Playwright
# Usage (layered on top of base docker-compose.yml):
#   docker-compose -f docker-compose.yml -f docker-compose.test.yml up -d
#   docker-compose -f docker-compose.yml -f docker-compose.test.yml exec playwright npx playwright test
#   docker-compose -f docker-compose.yml -f docker-compose.test.yml down

services:
  # Override php service for testing environment
  php:
    environment:
      APP_ENV: development
      # Mock BCP URLs point to the mock endpoints within this container
      BCP_MOCK_BASE_URL: http://localhost/mock-bcp
      BCP_MOCK_API_URL: http://localhost/mock-bcp-api
    # Override command to set environment variables for Apache
    command: >
      bash -c "a2enmod rewrite && docker-php-ext-install pdo pdo_mysql &&
      echo 'PassEnv APP_ENV BCP_MOCK_BASE_URL BCP_MOCK_API_URL' >> /etc/apache2/apache2.conf &&
      echo '<?php declare(strict_types=1); return [\"host\"=>\"mysql\",\"database\"=>\"tournament_tables\",\"username\"=>\"root\",\"password\"=>\"root\",\"charset\"=>\"utf8mb4\"];' > config/database.php &&
      php bin/migrate.php && apache2-foreground"
    healthcheck:
      test: ["CMD", "curl", "-sf", "http://localhost/api/terrain-types"]
      interval: 5s
      timeout: 5s
      retries: 10
      start_period: 30s

  # Override mysql to use separate test data volume
  mysql:
    volumes:
      - mysql_test_data:/var/lib/mysql

  # Playwright service for E2E browser tests
  playwright:
    image: mcr.microsoft.com/playwright:v1.57.0-noble
    working_dir: /app/tests/E2E
    volumes:
      - .:/app
      - playwright_cache:/root/.cache
    depends_on:
      php:
        condition: service_healthy
    environment:
      BASE_URL: http://php:80
      CI: "true"
    entrypoint: []
    command: ["tail", "-f", "/dev/null"]  # Keep container running for interactive use

  # Utility service for running migrations before tests
  migrate:
    image: php:7.4.33-cli
    volumes:
      - .:/var/www/app
    working_dir: /var/www/app
    depends_on:
      mysql:
        condition: service_healthy
    environment:
      DB_HOST: mysql
      DB_DATABASE: tournament_tables
      DB_USERNAME: root
      DB_PASSWORD: root
    entrypoint: []
    command: |
      bash -c "
        docker-php-ext-install pdo pdo_mysql &&
        mkdir -p config &&
        cat > config/database.php <<EOF
        <?php
        declare(strict_types=1);
        return [
            'host' => '${DB_HOST}',
            'database' => '${DB_DATABASE}',
            'username' => '${DB_USERNAME}',
            'password' => '${DB_PASSWORD}',
            'charset' => 'utf8mb4',
        ];
        EOF
        php bin/migrate.php &&
        php bin/seed-terrain-types.php
      "
    profiles:
      - setup

volumes:
  mysql_test_data:
  playwright_cache:
